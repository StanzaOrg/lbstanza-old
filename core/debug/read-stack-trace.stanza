defpackage core/debug/read-stack-trace :
  import core
  import collections
  import core/debug/system-types
  import core/dynamic-library
  import core/collect-stack-trace
  import core/stack-trace

public lostanza defn read-stack-trace (lib:ref<DynamicLibrary>) -> ref<SingleStackTrace> :
  val vmstate = app-vmstate(lib)
  val ctxt = current-sighandler-context()
  call-c clib/printf("ctxt.rsp = %lx\n", ctxt.rsp)
  val last-frame = ctxt.rsp as ptr<StackFrame>
  val app-pc = ctxt.rip

  ;Compute the address of the safepoint that we're stopped on.
  ;Note that the RIP is saved AFTER the INT3 instruction.
  val safepoint-pc = app-pc - 1
  
  return collect-stack-trace(vmstate, current-stack-frames(vmstate), last-frame, safepoint-pc)

;Return the ptr<VMState> structure of the user application.
lostanza defn app-vmstate (lib:ref<DynamicLibrary>) -> ptr<core/VMState> :
  val sym = dynamic-library-symbol(lib, String("stanza_vmstate"))
  return sym.address as ptr<core/VMState>