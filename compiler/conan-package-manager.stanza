defpackage stz/conan-package-manager :
  import core
  import collections
  import stz/proj-env
  import stz/external-dependencies
  import stz/foreign-package-manager
  import stz/proj-value-types

public defn ConanPackageManager () -> ForeignPackageManager :
  new ForeignPackageManager :

    ;Return the parameters that a user should specify in their .proj file.
    defmethod configuration-params (this) :
      ;Example: Suppose that user's are allowed to have the following
      ;in their .proj file:
      ;  foreign-package-params(conan) :
      ;    project-root: "mydir/myproject"
      ;    email: "patrick@jitx.com"
      ;Suppose that email is optional.
      ;PathField fields are automatically resolved to absolute paths.
      [TableEntry(`project-root,
                  SINGLE-PATH,
                  false)
       TableEntry(`email,
                  SINGLE-STRING,
                  true)]

    defmethod system-dependencies (this, params:PackageManagerParams) :
      ;Example: Suppose that the use of Conan means that the
      ;linker should include the additional flags "@buildargs".
      ;; Note: gcc recognizes the @file symbol to mean "Read command-line options from file"
      ;; https://gcc.gnu.org/onlinedocs/gcc/Overall-Options.html
      ProjDependencies([],
                       ["@buildargs"],
                       [])

    defmethod proj-variables (this, params:PackageManagerParams, platform:Symbol) -> Tuple<KeyValue<Symbol,?>> :
      ;Example: Suppose that the Conan package manager introduces
      ;the following two environment variables that users are allowed
      ;to now use in their .proj files: CONAN-BUILD-DIR, and CONAN-INCLUDES.
      ;Note that CONAN-BUILD-DIR is dependent upon how the user
      ;chose to configure Conan.
      val root = lookup(entries(params), `project-root)
      [
        `CONAN-BUILD-DIR => to-string("%_/.conan/build" % [root])
        `CONAN-INCLUDES => List("@buildargs")
      ]

    defmethod satisfy-dependencies (this,
                                    packages:Tuple<String>,
                                    params:PackageManagerParams,
                                    system:System) -> True|False :
      ;Example: Suppose we satisfy dependencies by calling 'conan install' in the project directory
      val root = lookup(entries(params), `project-root)
      ;call-system(system, "conan", ["conan" "install"], cwd: root])  # TODO pass cwd for command
      false
      ;;; no need for loop
      ;;; for package in packages do :
      ;;;   call-system(system, "conan", ["conan" "update" package])