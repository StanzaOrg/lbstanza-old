defpackage stz/reg-alloc-errors :
  import core
  import collections
  import stz/printing-utils

public deftype RegAllocError <: Exception

;Generic register allocation error.
public defn RegAllocError (msg) :
  new RegAllocError :
    defmethod print (o:OutputStream, this) :
      print(o, msg)

;Occurs when there is an error when reading syntax for
;RegAllocIR.
public defstruct RegAllocSyntaxError <: RegAllocError :
  info:FileInfo|False
  msg
defmethod print (o:OutputStream, e:RegAllocSyntaxError) :
  print(o, "%_%_" % [info-str(info(e)), msg(e)])

;Helper: Create the information string.
defn info-str (info:FileInfo|False) :
  "" when info is False else "%_: " % [info]

;============================================================
;================== Operation Model Errors ==================
;============================================================

;Report all errors within an OperationModel.
public defstruct OperationModelError <: RegAllocError :
  id:Int
  errors:Tuple<Exception>
defmethod print (o:OutputStream, e:OperationModelError) :
  print(o, "Invalid operation model op%_%_" % [
    id(e), colon-field-list(errors(e))])

public defn BadlyIndexedVar () :
  RegAllocSyntaxError(false, "BadlyIndexedVar")
public defn BadPreferenceForRequiredRegister () :
  RegAllocSyntaxError(false, "BadPreferenceForRequiredRegister")
public defn PreferSameNotAllowed () :
  RegAllocSyntaxError(false, "PreferSameNotAllowed")
public defn BadPreferSame () :
  RegAllocSyntaxError(false, "BadPreferSame")
public defn PreferSameOfRequiredRegister () :
  RegAllocSyntaxError(false, "PreferSameOfRequiredRegister")
public defn PreferSameDifferentType () :
  RegAllocSyntaxError(false, "PreferSameDifferentType")
public defn DuplicateRequiredReg () :
  RegAllocSyntaxError(false, "DuplicateRequiredReg")
public defn ReleaseBadVar () :
  RegAllocSyntaxError(false, "ReleaseBadVar")
public defn AlreadyReleased () :
  RegAllocSyntaxError(false, "AlreadyReleased")
public defn BadReleaseAfterClearRegisters () :
  RegAllocSyntaxError(false, "BadReleaseAfterClearRegisters")
public defn AssignToBadVar () :
  RegAllocSyntaxError(false, "AssignToBadVar")
public defn AlreadyAssigned () :
  RegAllocSyntaxError(false, "AlreadyAssigned")
public defn BadAssignAfterClearRegisters () :
  RegAllocSyntaxError(false, "BadAssignAfterClearRegisters")
public defn BadAssignBeforeClearRegisters () :
  RegAllocSyntaxError(false, "BadAssignBeforeClearRegisters")
public defn ReturnNotLastStmt () :
  RegAllocSyntaxError(false, "ReturnNotLastStmt")
public defn ReturnWithResults () :
  RegAllocSyntaxError(false, "ReturnWithResults")
public defn ReturnWithClearRegisters () :
  RegAllocSyntaxError(false, "ReturnWithClearRegisters")
public defn RedundantClearRegisters () :
  RegAllocSyntaxError(false, "RedundantClearRegisters")
public defn UnassignedVar () :
  RegAllocSyntaxError(false, "UnassignedVar")
public defn UnreleasedVar () :
  RegAllocSyntaxError(false, "UnreleasedVar")
public defn AlreadyAssignedReg () :
  RegAllocSyntaxError(false, "AlreadyAssignedReg")
public defn BadlyFormedLocation () :
  RegAllocSyntaxError(false, "BadlyFormedLocation")

;============================================================
;================== Program Errors ==========================
;============================================================

;Report all errors within a Program
public defstruct ProgramErrors <: RegAllocError :
  errors: Tuple<Exception>
defmethod print (o:OutputStream, e:ProgramErrors) :
  print(o, "Program is invalid%_" % [colon-field-list(errors(e))])

public defn BadIndexedProgramVar () :
  RegAllocSyntaxError(false, "BadIndexedProgramVar")
public defn BadlyIndexedLabel () :
  RegAllocSyntaxError(false, "BadlyIndexedLabel")
public defn DuplicateLabel () :
  RegAllocSyntaxError(false, "DuplicateLabel")
public defn BadTarget () :
  RegAllocSyntaxError(false, "BadTarget")
public defn BadOp () :
  RegAllocSyntaxError(false, "BadOp")
public defn BadProgramVar () :
  RegAllocSyntaxError(false, "BadProgramVar")
  
public defn BadArgArity (op-id:Int,
                         expected-arguments:Int,
                         given-arguments:Int) :
  val msg = "Incorrect call to op%_ with %_ arguments. %_ arguments were expected."
  RegAllocError(msg % [op-id, given-arguments, expected-arguments])
  
public defn BadResultArity (op-id:Int,
                            expected-results:Int,
                            given-results:Int) :
  val msg = "Incorrect call to op%_ with %_ results. %_ results were expected."
  RegAllocError(msg % [op-id, given-results, expected-results])
  
public defn BadArgType () :
  RegAllocSyntaxError(false, "BadArgType")
public defn BadResultType () :
  RegAllocSyntaxError(false, "BadResultType")

public defn RepeatedVarInOp (op-id:Int, v:Int) :
  val msg = "Repeated usage of V%_ in call to op%_."
  RegAllocError(msg % [v, op-id])
    

   
    