defpackage stz/asm-ir :
   import core
   import verse

;======== Utilities ========
val id-counter = to-stream(0 to false)

;======== Assembly Operations ========
public defstruct AsmOp :
   id:Int
   
defmethod equal? (a:AsmOp, b:AsmOp) :
   id(a) == id(b)

defn AsmOp () : AsmOp(next(id-counter))
public val ADD-OP = AsmOp()
public val SUB-OP = AsmOp()
public val MUL-OP = AsmOp()
public val DIV-OP = AsmOp()
public val MOD-OP = AsmOp()
public val AND-OP = AsmOp()
public val OR-OP = AsmOp()
public val XOR-OP = AsmOp()
public val SHL-OP = AsmOp()
public val SHR-OP = AsmOp()
public val ASHR-OP = AsmOp()
public val EQ-OP = AsmOp()
public val NE-OP = AsmOp()
public val LT-OP = AsmOp()
public val GT-OP = AsmOp()
public val LE-OP = AsmOp()
public val GE-OP = AsmOp()
public val ULE-OP = AsmOp()
public val ULT-OP = AsmOp()
public val UGT-OP = AsmOp()
public val UGE-OP = AsmOp()

;======== Assembly Types ========
public defstruct AsmType :
   id: Int
   
defmethod equal? (a:AsmType, b:AsmType) :
   id(a) == id(b)

defn AsmType () : AsmType(next(id-counter))   
public val BYTE-TYPE = AsmType()
public val INT-TYPE = AsmType()
public val LONG-TYPE = AsmType()
public val FLOAT-TYPE = AsmType()
public val DOUBLE-TYPE = AsmType()

;======== Assembly Instructions ========
public definterface Ins
public defstruct SetIns <: Ins :
   type: AsmType
   x: Loc
   y: Imm
public defstruct BinOp <: Ins :
   type: AsmType
   x: Loc
   op: AsmOp
   y: Imm
   z: Imm
public defstruct DualOp <: Ins :
   type: AsmType
   x1: Loc
   x2: Loc
   op: AsmOp
   y: Imm
   z: Imm
public defstruct Load <: Ins :
   type: AsmType
   x: Loc
   y: Imm
   offset: Int
public defstruct Store <: Ins :
   type: AsmType
   x: Imm
   y: Imm
   offset: Int
public defstruct Label <: Ins :
   n: Int
public defstruct ExLabel <: Ins :
   name: Symbol
public defstruct Goto <: Ins :
   x: Imm
public defstruct Branch <: Ins :
   type: AsmType
   x: Imm
   op: AsmOp
   y: Imm
   z: Imm
public defstruct Call <: Ins :
   x: Imm
public defstruct Addr <: Ins :
   x: Loc
   y: Loc
   offset: Int
public defstruct Return <: Ins
public defstruct SignExtend <: Ins :
   x: Loc
   y: Imm
   xtype: AsmType
   ytype: AsmType
public defstruct ZeroExtend <: Ins :
   x: Loc
   y: Imm
   xtype: AsmType
   ytype: AsmType

;======== Data Instructions ========
public defstruct DefLong <: Ins :
   value: Int
public defstruct DefFloat <: Ins :
   value: Float
public defstruct DefDouble <: Ins :
   value: Float
public defstruct DefString <: Ins :
   value: String
public defstruct DefSpace <: Ins :
   size: Int
public defstruct DefLabel <: Ins :
   n: Int
public defstruct DefData <: Ins
public defstruct DefText <: Ins

;======== Assembly Immediates ========
public definterface Imm
public defstruct IntImm <: Imm :
   value: Int
;public defstruct FloatImm <: Imm :
;   value: Float

public definterface Loc <: Imm
public defstruct Reg <: Loc : (n:Int)
public defstruct RegSP <: Loc
public defstruct Mem <: Loc : (n:Int)
public defstruct ExMem <: Loc : (name:Symbol)

defmethod equal? (a:Imm, b:Imm) :
   match(a, b) :
      (a:Reg, b:Reg) : n(a) == n(b)
      (a:RegSP, b:RegSP) : true
      (a:Mem, b:Mem) : n(a) == n(b)
      (a:ExMem, b:ExMem) : name(a) == name(b)
      (a:IntImm, b:IntImm) : value(a) == value(b)
      (a, b) : false