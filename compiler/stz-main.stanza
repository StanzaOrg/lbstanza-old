#include("core/stringeater.stanza")
#include("compiler/stz-params.stanza")
#include("compiler/stz-lexer.stanza")
#include("compiler/stz-parser.stanza")
#include("core/macro-utils.stanza")
#include("compiler/stz-core-macros.stanza")
#include("compiler/stz-algorithms.stanza")
#include("compiler/stz-il-ir.stanza")
#include("compiler/stz-utils.stanza")
#include("compiler/stz-ids.stanza")
#include("compiler/stz-input.stanza")
#include("compiler/lang-read.stanza")
#include("compiler/lang-check.stanza")
#include("compiler/stz-namemap.stanza")
#include("compiler/stz-renamer.stanza")
#include("compiler/stz-primitives.stanza")
#include("compiler/stz-resolver.stanza")
#include("compiler/stz-tl-ir.stanza")
#include("compiler/stz-type.stanza")
#include("compiler/stz-infer.stanza")
#include("compiler/stz-type-calculus.stanza")
#include("compiler/stz-kl-ir.stanza")
#include("compiler/stz-kform.stanza")
#include("compiler/stz-padder.stanza")
#include("compiler/stz-tgt-ir.stanza")
#include("compiler/stz-tgt.stanza")
#include("compiler/stz-bb-ir.stanza")
#include("compiler/stz-bb.stanza")
#include("compiler/stz-backend.stanza")
#include("compiler/stz-asm-ir.stanza")
#include("compiler/stz-asm-emitter.stanza")
#include("compiler/stz-compiler.stanza")

defpackage stz/main :
   import core
   import verse
   import stz/compiler

;============================================================
;================== Parameter Parsing =======================
;============================================================

defn parse-parameters (args:Array<String>, flags:List<Symbol>) :
   val table = HashTable<Symbol,List<Symbol>>(symbol-hash)
   var flag: False|Symbol = false
   for arg in stream(to-symbol, args) do :
      if arg[0] == '-' :
         if contains?(flags, arg) :
            error("Duplicate flag: ~" % [arg]) when key?(table, arg)
            table[arg] = List()
            flag = arg
         else :
            error("Unrecognized flag: ~" % [arg])
      else :
         match(flag) :
            (flag:Symbol) : table[flag] = List(arg, table[flag])
            (flag:False) : false
   for k in keys(table) do :
      table[k] = reverse(table[k])
   table

;============================================================
;===================== Driver ===============================
;============================================================

defn main () :
   val params = parse-parameters(commandline-arguments(), `(-i, -o))
   val input-files = map(to-string, params[`-i])
   val output-file = to-string(head(params[`-o]))
   compile(input-files, output-file)

main()