defpackage stz/test-reg-alloc-reader :
  import core
  import collections
  import stz/reg-alloc-reader  
  import stz/reg-alloc-errors
  import stz/reg-alloc-model-analysis
  import stz/reg-alloc-blocks
  import stz/reg-alloc-engine
  import stz/reg-alloc-liveness
  import arg-parser

defn main () :
  val filename = command-line-arguments()[1]
  val forms = reader/read-file(filename)
  val [prog, models] = match-syntax[reg-alloc-ir](forms) :
    (?prog:#prog
     ?models:#model! ...) :
      [prog, to-tuple(models)]
    (_ ...) :
      throw(RegAllocSyntaxError(false, "Invalid file."))
      
  println("\n\n===== Input =====")    
  println("%_\n" % [prog])
  for m in models do :
    println("%_\n" % [m])

  val model-properties = analyze-models(models)
  println("\n\n===== Model Properties =====")
  do(println, model-properties)

  val engine = RegAllocEngine(prog, model-properties)
  println("\n\n===== Engine =====")
  println(engine)

  println("\n\n==== Analyze Basic Blocks =====")
  analyze-basic-blocks(engine)
  println(engine)

  println("\n\n==== Compute Liveness =====")
  compute-live(engine)
  println(engine)
    

set-command-line-arguments(["test-reader", "testdata/reg-alloc-ex1.ir"])
main()